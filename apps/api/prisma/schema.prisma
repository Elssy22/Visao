// Visao - Schema Prisma
// Base de données PostgreSQL (Supabase)
// Multi-tenant avec support White-label

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Pour Supabase pooling
}

// ==================== ORGANISATIONS (Multi-tenant) ====================

model Organization {
  id            String   @id @default(cuid())
  name          String   // "Visao", "Agence X", "Marque Y"
  slug          String   @unique // "visao", "agence-x" (utilisé dans l'URL)

  // White-label (Phase 2)
  customDomain  String?  @unique // "veille.agencex.com"
  logo          String?  // URL du logo (Supabase Storage)
  primaryColor  String?  @default("#3b82f6") // Couleur principale
  secondaryColor String? @default("#1e293b") // Couleur secondaire

  // Abonnement
  plan          Plan     @default(FREE)
  planExpiresAt DateTime?

  // Limites selon le plan
  maxUsers      Int      @default(1)
  maxSources    Int      @default(3)

  // Relations
  profiles      Profile[]
  sources       Source[]
  invitations   Invitation[]
  sourceSuggestions SourceSuggestion[]

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("organizations")
  @@index([slug])
  @@index([customDomain])
}

enum Plan {
  FREE        // 3 sources, 1 user, pas de notifs push
  STARTER     // 10 sources, 3 users - 29€/mois
  PRO         // 50 sources, 10 users - 79€/mois
  ENTERPRISE  // Illimité - sur devis
}

// ==================== PROFILS UTILISATEURS ====================
// Note: L'auth est gérée par Supabase Auth
// Cette table étend les données de auth.users

model Profile {
  id            String    @id // Même ID que auth.users
  email         String    @unique
  name          String?
  role          UserRole  @default(EDITOR)
  avatar        String?   // URL Supabase Storage
  isActive      Boolean   @default(true) @map("is_active")

  // Appartenance à une organisation
  organizationId String   @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  alerts            Alert[]           @relation("AssignedAlerts")
  savedContents     SavedContent[]
  publications      Publication[]
  pushSubscriptions PushSubscription[]
  sourceSuggestions SourceSuggestion[]

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")

  @@map("profiles")
  @@index([organizationId])
  @@index([email])
}

enum UserRole {
  OWNER   // Propriétaire de l'organisation (peut tout faire + supprimer l'org)
  ADMIN   // Peut tout faire sauf supprimer l'org
  EDITOR  // Peut ajouter sources, publier, sauvegarder
  VIEWER  // Peut uniquement consulter le feed
}

model Invitation {
  id             String   @id @default(cuid())
  email          String
  role           UserRole @default(EDITOR)
  organizationId String   @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  token          String   @unique
  expiresAt      DateTime @map("expires_at")
  acceptedAt     DateTime? @map("accepted_at")

  createdAt      DateTime @default(now()) @map("created_at")

  @@map("invitations")
  @@index([token])
  @@index([organizationId])
}

model PushSubscription {
  id        String   @id @default(cuid())
  profileId String   @map("profile_id")
  profile   Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  keys      Json     // { p256dh, auth }
  userAgent String?  @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("push_subscriptions")
  @@index([profileId])
}

// ==================== SOURCES ====================

model Source {
  id            String      @id @default(cuid())
  name          String
  type          SourceType
  url           String      // URL ou identifiant (@username, etc.)
  identifier    String?     // ID spécifique à la plateforme
  isActive      Boolean     @default(true) @map("is_active")
  checkInterval Int         @default(60) @map("check_interval") // Intervalle en secondes
  lastCheckedAt DateTime?   @map("last_checked_at")
  lastError     String?     @map("last_error") // Dernière erreur de fetch

  // Métadonnées de la source
  metadata      Json?       // Avatar, bio, followers, etc.

  // Appartenance à une organisation
  organizationId String     @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  alerts        Alert[]

  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  @@map("sources")
  @@unique([organizationId, type, identifier])
  @@index([type, isActive])
  @@index([organizationId])
}

enum SourceType {
  TWITTER
  INSTAGRAM
  TIKTOK
  RSS
  WEBSITE
}

// ==================== SOUMISSION DE SOURCES ====================

model SourceSuggestion {
  id             String   @id @default(cuid())

  // Qui propose
  profileId      String   @map("profile_id")
  profile        Profile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Organisation concernée
  organizationId String   @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // La source proposée
  name           String
  type           SourceType
  url            String
  reason         String?  @db.Text // "Très réactif sur les leaks Nike"

  // Statut
  status         SuggestionStatus @default(PENDING)
  reviewedById   String?  @map("reviewed_by_id") // Admin qui a review
  reviewNote     String?  @map("review_note") // "Doublon" ou "Pas pertinent"

  createdAt      DateTime @default(now()) @map("created_at")
  reviewedAt     DateTime? @map("reviewed_at")

  @@map("source_suggestions")
  @@index([organizationId, status])
  @@index([profileId])
}

enum SuggestionStatus {
  PENDING   // En attente de review
  APPROVED  // Accepté et ajouté
  REJECTED  // Refusé
}

// ==================== ALERTES ====================

model Alert {
  id           String      @id @default(cuid())
  sourceId     String      @map("source_id")
  source       Source      @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  // Contenu original
  externalId   String      @map("external_id") // ID du post sur la plateforme
  content      String      @db.Text
  authorName   String      @map("author_name")
  authorHandle String      @map("author_handle")
  authorAvatar String?     @map("author_avatar")
  permalink    String      // Lien vers le post original

  // Médias
  media        Media[]

  // Statut
  status       AlertStatus @default(NEW)
  isRead       Boolean     @default(false) @map("is_read")
  isPinned     Boolean     @default(false) @map("is_pinned")

  // Assignation (optionnel - pour le travail d'équipe)
  assignedToId String?     @map("assigned_to_id")
  assignedTo   Profile?    @relation("AssignedAlerts", fields: [assignedToId], references: [id])

  // Relations
  savedContent SavedContent?
  publications Publication[]

  detectedAt   DateTime    @default(now()) @map("detected_at")
  postedAt     DateTime    @map("posted_at") // Date du post original

  @@map("alerts")
  @@unique([sourceId, externalId])
  @@index([status, detectedAt])
  @@index([sourceId])
  @@index([assignedToId])
}

enum AlertStatus {
  NEW        // Vient d'arriver
  VIEWED     // Vu mais pas traité
  SAVED      // Sauvegardé pour plus tard
  PUBLISHED  // Publié sur X
  DISMISSED  // Ignoré
}

model Media {
  id          String    @id @default(cuid())
  alertId     String    @map("alert_id")
  alert       Alert     @relation(fields: [alertId], references: [id], onDelete: Cascade)

  type        MediaType
  originalUrl String    @map("original_url")
  storedUrl   String?   @map("stored_url") // URL Supabase Storage
  thumbnail   String?

  // Métadonnées
  width       Int?
  height      Int?
  duration    Int?      // Pour les vidéos (en secondes)
  size        Int?      // Taille en bytes

  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("media")
  @@index([alertId])
}

enum MediaType {
  IMAGE
  VIDEO
  GIF
}

// ==================== CONTENUS SAUVEGARDÉS ====================

model SavedContent {
  id        String   @id @default(cuid())
  alertId   String   @unique @map("alert_id")
  alert     Alert    @relation(fields: [alertId], references: [id], onDelete: Cascade)
  profileId String   @map("profile_id")
  profile   Profile  @relation(fields: [profileId], references: [id])

  notes     String?  @db.Text
  tags      String[] // Tags personnalisés

  createdAt DateTime @default(now()) @map("created_at")

  @@map("saved_contents")
  @@index([profileId, createdAt])
}

// ==================== PUBLICATIONS ====================

model Publication {
  id          String            @id @default(cuid())
  alertId     String?           @map("alert_id")
  alert       Alert?            @relation(fields: [alertId], references: [id])
  profileId   String            @map("profile_id")
  profile     Profile           @relation(fields: [profileId], references: [id])

  platform    PublishPlatform
  content     String            @db.Text
  mediaUrls   String[]          @map("media_urls")

  // Résultat
  status      PublishStatus     @default(PENDING)
  externalId  String?           @map("external_id") // ID du tweet publié
  externalUrl String?           @map("external_url") // URL du tweet
  error       String?

  scheduledAt DateTime?         @map("scheduled_at")
  publishedAt DateTime?         @map("published_at")
  createdAt   DateTime          @default(now()) @map("created_at")

  @@map("publications")
  @@index([profileId, status])
  @@index([profileId, createdAt])
}

enum PublishPlatform {
  TWITTER
}

enum PublishStatus {
  PENDING    // En attente
  SCHEDULED  // Programmé
  PUBLISHED  // Publié avec succès
  FAILED     // Échec
}

// ==================== VEILLE CONCURRENTIELLE ====================

model Competitor {
  id             String   @id @default(cuid())
  name           String
  handle         String   // @username sur X
  url            String?  // Site web
  organizationId String   @map("organization_id")

  createdAt      DateTime @default(now()) @map("created_at")

  @@map("competitors")
  @@index([organizationId])
}

// ==================== CONFIGURATION SYSTÈME ====================

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_config")
}

// ==================== AUDIT LOG ====================

model AuditLog {
  id             String   @id @default(cuid())
  profileId      String?  @map("profile_id")
  organizationId String?  @map("organization_id")
  action         String   // "source.created", "alert.published", etc.
  entityType     String?  @map("entity_type") // "Source", "Alert", "Profile"
  entityId       String?  @map("entity_id")
  metadata       Json?    // Détails supplémentaires
  ipAddress      String?  @map("ip_address")
  userAgent      String?  @map("user_agent")

  createdAt      DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
  @@index([organizationId, createdAt])
  @@index([profileId, createdAt])
  @@index([action])
}
