// Visao - Schema Prisma
// Base de données PostgreSQL
// Multi-tenant avec support White-label

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ORGANISATIONS (Multi-tenant) ====================

model Organization {
  id            String   @id @default(cuid())
  name          String   // "Visao", "Agence X", "Marque Y"
  slug          String   @unique // "visao", "agence-x" (utilisé dans l'URL)

  // White-label (Phase 2)
  customDomain  String?  @unique // "veille.agencex.com"
  logo          String?  // URL du logo
  primaryColor  String?  @default("#3b82f6") // Couleur principale
  secondaryColor String? @default("#1e293b") // Couleur secondaire

  // Abonnement
  plan          Plan     @default(FREE)
  planExpiresAt DateTime?

  // Limites selon le plan
  maxUsers      Int      @default(1)
  maxSources    Int      @default(3)

  // Relations
  users         User[]
  sources       Source[]
  invitations   Invitation[]
  sourceSuggestions SourceSuggestion[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([slug])
  @@index([customDomain])
}

enum Plan {
  FREE        // 3 sources, 1 user, pas de notifs push
  STARTER     // 10 sources, 3 users - 29€/mois
  PRO         // 50 sources, 10 users - 79€/mois
  ENTERPRISE  // Illimité - sur devis
}

// ==================== UTILISATEURS ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  role          UserRole  @default(EDITOR)
  avatar        String?
  isActive      Boolean   @default(true)

  // Appartenance à une organisation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  alerts            Alert[]
  savedContents     SavedContent[]
  publications      Publication[]
  pushSubscriptions PushSubscription[]
  sourceSuggestions SourceSuggestion[]

  // Tokens
  refreshTokens     RefreshToken[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  @@index([organizationId])
  @@index([email])
}

enum UserRole {
  OWNER   // Propriétaire de l'organisation (peut tout faire + supprimer l'org)
  ADMIN   // Peut tout faire sauf supprimer l'org
  EDITOR  // Peut ajouter sources, publier, sauvegarder
  VIEWER  // Peut uniquement consulter le feed
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model Invitation {
  id             String   @id @default(cuid())
  email          String
  role           UserRole @default(EDITOR)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  token          String   @unique
  expiresAt      DateTime
  acceptedAt     DateTime?

  createdAt      DateTime @default(now())

  @@index([token])
  @@index([organizationId])
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  keys      Json     // { p256dh, auth }
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
}

// ==================== SOURCES ====================

model Source {
  id            String      @id @default(cuid())
  name          String
  type          SourceType
  url           String      // URL ou identifiant (@username, etc.)
  identifier    String?     // ID spécifique à la plateforme
  isActive      Boolean     @default(true)
  checkInterval Int         @default(60) // Intervalle en secondes
  lastCheckedAt DateTime?
  lastError     String?     // Dernière erreur de fetch

  // Métadonnées de la source
  metadata      Json?       // Avatar, bio, followers, etc.

  // Appartenance à une organisation
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relations
  alerts        Alert[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([organizationId, type, identifier])
  @@index([type, isActive])
  @@index([organizationId])
}

enum SourceType {
  TWITTER
  INSTAGRAM
  TIKTOK
  RSS
  WEBSITE
}

// ==================== SOUMISSION DE SOURCES ====================

model SourceSuggestion {
  id             String   @id @default(cuid())

  // Qui propose
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Organisation concernée
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // La source proposée
  name           String
  type           SourceType
  url            String
  reason         String?  @db.Text // "Très réactif sur les leaks Nike"

  // Statut
  status         SuggestionStatus @default(PENDING)
  reviewedById   String?  // Admin qui a review
  reviewNote     String?  // "Doublon" ou "Pas pertinent"

  createdAt      DateTime @default(now())
  reviewedAt     DateTime?

  @@index([organizationId, status])
  @@index([userId])
}

enum SuggestionStatus {
  PENDING   // En attente de review
  APPROVED  // Accepté et ajouté
  REJECTED  // Refusé
}

// ==================== ALERTES ====================

model Alert {
  id           String      @id @default(cuid())
  sourceId     String
  source       Source      @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  // Contenu original
  externalId   String      // ID du post sur la plateforme
  content      String      @db.Text
  authorName   String
  authorHandle String
  authorAvatar String?
  permalink    String      // Lien vers le post original

  // Médias
  media        Media[]

  // Statut
  status       AlertStatus @default(NEW)
  isRead       Boolean     @default(false)
  isPinned     Boolean     @default(false)

  // Assignation (optionnel - pour le travail d'équipe)
  assignedToId String?
  assignedTo   User?       @relation(fields: [assignedToId], references: [id])

  // Relations
  savedContent SavedContent?
  publications Publication[]

  detectedAt   DateTime    @default(now())
  postedAt     DateTime    // Date du post original

  @@unique([sourceId, externalId])
  @@index([status, detectedAt])
  @@index([sourceId])
  @@index([assignedToId])
}

enum AlertStatus {
  NEW        // Vient d'arriver
  VIEWED     // Vu mais pas traité
  SAVED      // Sauvegardé pour plus tard
  PUBLISHED  // Publié sur X
  DISMISSED  // Ignoré
}

model Media {
  id          String    @id @default(cuid())
  alertId     String
  alert       Alert     @relation(fields: [alertId], references: [id], onDelete: Cascade)

  type        MediaType
  originalUrl String
  storedUrl   String?   // URL après stockage local (R2)
  thumbnail   String?

  // Métadonnées
  width       Int?
  height      Int?
  duration    Int?      // Pour les vidéos (en secondes)
  size        Int?      // Taille en bytes

  createdAt   DateTime  @default(now())

  @@index([alertId])
}

enum MediaType {
  IMAGE
  VIDEO
  GIF
}

// ==================== CONTENUS SAUVEGARDÉS ====================

model SavedContent {
  id        String   @id @default(cuid())
  alertId   String   @unique
  alert     Alert    @relation(fields: [alertId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  notes     String?  @db.Text
  tags      String[] // Tags personnalisés

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

// ==================== PUBLICATIONS ====================

model Publication {
  id          String            @id @default(cuid())
  alertId     String?
  alert       Alert?            @relation(fields: [alertId], references: [id])
  userId      String
  user        User              @relation(fields: [userId], references: [id])

  platform    PublishPlatform
  content     String            @db.Text
  mediaUrls   String[]

  // Résultat
  status      PublishStatus     @default(PENDING)
  externalId  String?           // ID du tweet publié
  externalUrl String?           // URL du tweet
  error       String?

  scheduledAt DateTime?
  publishedAt DateTime?
  createdAt   DateTime          @default(now())

  @@index([userId, status])
  @@index([userId, createdAt])
}

enum PublishPlatform {
  TWITTER
}

enum PublishStatus {
  PENDING    // En attente
  SCHEDULED  // Programmé
  PUBLISHED  // Publié avec succès
  FAILED     // Échec
}

// ==================== VEILLE CONCURRENTIELLE ====================

model Competitor {
  id             String   @id @default(cuid())
  name           String
  handle         String   // @username sur X
  url            String?  // Site web
  organizationId String   // Appartient à une organisation

  createdAt      DateTime @default(now())

  @@index([organizationId])
}

// ==================== CONFIGURATION SYSTÈME ====================

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
}

// ==================== AUDIT LOG (optionnel mais recommandé) ====================

model AuditLog {
  id             String   @id @default(cuid())
  userId         String?
  organizationId String?
  action         String   // "source.created", "alert.published", etc.
  entityType     String?  // "Source", "Alert", "User"
  entityId       String?
  metadata       Json?    // Détails supplémentaires
  ipAddress      String?
  userAgent      String?

  createdAt      DateTime @default(now())

  @@index([organizationId, createdAt])
  @@index([userId, createdAt])
  @@index([action])
}
